{% extends 'admin/base.html' %}
{% block title %}Corre√ß√£o de Descarga{% endblock %}
{% block page_title %}Corre√ß√£o de Descarga{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <p class="text-muted">Selecione uma descarga para corrigir posi√ß√£o e demais campos.</p>

  <!-- Container principal para lista/formul√°rio -->
  <div id="correcao-descarga-container" class="formulario-dinamico">
    <div class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-2">Carregando descargas corrig√≠veis...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- M√≥dulos utilit√°rios -->
  <script src="/static/js/modules/ui-utils.js" type="module"></script>
  
  <!-- Script de debug para sess√£o e permiss√µes -->
  <script>
    // Debug da sess√£o em tempo real
    window.debugSession = async function() {
      console.log('üîç DEBUGANDO SESS√ÉO DO USU√ÅRIO');
      
      try {
        console.log('=== VERIFICANDO SESS√ÉO ===');
        const response = await fetch('/auth/check-session');
        const data = await response.json();
        
        console.log('Status da resposta:', response.status);
        console.log('Dados da sess√£o:', data);
        
        if (data.valid) {
          console.log('‚úÖ Sess√£o v√°lida:');
          console.log('  Username:', data.username);
          console.log('  Role:', data.role);
          console.log('  Unidade:', data.unidade);
        } else {
          console.log('‚ùå Sess√£o inv√°lida');
        }
        
        // Verificar token CSRF
        console.log('\n=== VERIFICANDO TOKEN CSRF ===');
        const sources = [
          { name: 'meta[name="csrf-token"]', value: document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') },
          { name: 'input[name="csrf_token"]', value: document.querySelector('input[name="csrf_token"]')?.value },
          { name: 'csrf-token-input', value: document.getElementById('csrf-token-input')?.value },
          { name: 'window.csrfToken', value: window.csrfToken }
        ];
        
        let csrfToken = null;
        sources.forEach(source => {
          if (source.value) {
            console.log(`‚úÖ ${source.name}: ${source.value.substring(0, 10)}...`);
            if (!csrfToken) csrfToken = source.value;
          } else {
            console.log(`‚ùå ${source.name}: n√£o encontrado`);
          }
        });
        
        return { session: data, csrfToken };
        
      } catch (error) {
        console.error('‚ùå Erro ao verificar sess√£o:', error);
        return null;
      }
    };
    
    // Fun√ß√£o para testar requisi√ß√£o de corre√ß√£o
    window.testCorrection = async function(operacaoId = 75) {
      console.log('\n=== TESTANDO REQUISI√á√ÉO DE CORRE√á√ÉO ===');
      
      const debug = await window.debugSession();
      if (!debug || !debug.session.valid) {
        console.error('‚ùå Sess√£o inv√°lida - fa√ßa login novamente');
        return;
      }
      
      if (!debug.csrfToken) {
        console.error('‚ùå Token CSRF n√£o encontrado');
        return;
      }
      
      const dadosTest = {
        nova_posicao: 'A01-1',
        observacoes: 'Teste de debug - ' + new Date().toISOString(),
        csrf_token: debug.csrfToken
      };
      
      try {
        console.log(`Enviando requisi√ß√£o de teste para opera√ß√£o ${operacaoId}...`);
        
        const response = await fetch(`/operacoes/descargas/${operacaoId}/corrigir`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': debug.csrfToken
          },
          body: JSON.stringify(dadosTest)
        });
        
        console.log('Status da resposta:', response.status);
        console.log('Headers da resposta:', [...response.headers.entries()]);
        
        const responseText = await response.text();
        console.log('Corpo da resposta:', responseText);
        
        if (response.status === 403) {
          console.error('‚ùå ERRO 403: Acesso negado');
          console.log('Poss√≠veis causas:');
          console.log('  1. Sess√£o expirada');
          console.log('  2. Permiss√µes insuficientes');
          console.log('  3. Token CSRF inv√°lido');
          console.log('  4. Valida√ß√£o adicional falhando');
        } else if (response.status === 200) {
          console.log('‚úÖ Requisi√ß√£o bem-sucedida!');
        }
        
      } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
      }
    };
    
    console.log('üîß Fun√ß√µes de debug carregadas:');
    console.log('  - debugSession(): Verifica sess√£o e CSRF');
    console.log('  - testCorrection(operacaoId): Testa corre√ß√£o de descarga');
  </script>

  <!-- M√≥dulo de corre√ß√£o de descarga -->
  <script type="module">
    import { init } from '/static/js/modules/correcao-descarga.js';
    
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Inicializa o m√≥dulo com o estado da aplica√ß√£o
        init({ appState: window.appState || {} });
        console.log('‚úÖ M√≥dulo de corre√ß√£o de descarga inicializado');
        
        // Executar debug autom√°tico
        setTimeout(() => {
          console.log('\nüöÄ Executando debug autom√°tico da sess√£o...');
          window.debugSession();
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Erro ao inicializar m√≥dulo de corre√ß√£o:', error);
        document.getElementById('correcao-descarga-container').innerHTML = `
          <div class="alert alert-danger">
            <h4>Erro ao carregar m√≥dulo</h4>
            <p>${error.message}</p>
            <button class="btn btn-outline-danger" onclick="location.reload()">Tentar novamente</button>
          </div>
        `;
      }
    });
  </script>
{% endblock %}
