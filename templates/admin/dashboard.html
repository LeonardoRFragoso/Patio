{% extends "admin/base.html" %}

{% block title %}Dashboard Administrativo - Sistema de Pátio{% endblock %}

{% block extra_css %}
<!-- CSS do tema admin -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-theme.css') }}">
{% endblock %}

{% block content %}
<!-- Conteúdo principal do dashboard -->
<div class="main-content">
            <!-- Header da página -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h1>
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard Administrativo
                    </h1>
                    <div class="btn-toolbar">
                        <div class="btn-group">
                            <a href="{{ url_for('admin.novo_usuario') }}" class="btn btn-outline-primary">
                                <i class="fas fa-user-plus me-1"></i> Novo Usuário
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cards de estatísticas -->
            <div class="admin-stats fade-in-up">
                <div class="stat-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Total de Usuários</div>
                            <div class="stat-value">{{ total_usuarios }}</div>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-users fa-3x text-itracker-blue"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Administradores</div>
                            <div class="stat-value text-itracker-orange">{{ total_admins }}</div>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-user-shield fa-3x text-itracker-orange"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Usuários Padrão</div>
                            <div class="stat-value text-success">{{ total_users }}</div>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-user fa-3x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solicitações de Recuperação de Senha -->
            {% if senha_pendentes %}
            <div class="admin-card mb-4 slide-in-left">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>
                        Solicitações de Recuperação de Senha
                        <span class="badge bg-warning ms-2">{{ senha_pendentes|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for solicitacao in senha_pendentes %}
                                <tr>
                                    <td>
                                        <i class="fas fa-clock me-1 text-muted"></i>
                                        {{ solicitacao.data_solicitacao }}
                                    </td>
                                    <td>
                                        <i class="fas fa-user me-1 text-muted"></i>
                                        {{ solicitacao.username }}
                                    </td>
                                    <td>
                                        <i class="fas fa-envelope me-1 text-muted"></i>
                                        {{ solicitacao.email }}
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">
                                            <i class="fas fa-hourglass-half me-1"></i>
                                            Pendente
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-success btn-sm" 
                                                    onclick="processarSolicitacaoSenha({{ solicitacao.id }}, '{{ solicitacao.username }}', 'aprovar')"
                                                    title="Aprovar e redefinir senha">
                                                <i class="fas fa-check me-1"></i>
                                                Aprovar
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" 
                                                    onclick="processarSolicitacaoSenha({{ solicitacao.id }}, '{{ solicitacao.username }}', 'rejeitar')"
                                                    title="Rejeitar solicitação">
                                                <i class="fas fa-times me-1"></i>
                                                Rejeitar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Logs recentes -->
            <div class="admin-card mb-4 slide-in-right">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Atividades Recentes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Nível</th>
                                    <th>Ação</th>
                                    <th>Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if logs_recentes %}
                                    {% for log in logs_recentes %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-clock me-1 text-muted"></i>
                                            {{ log.data_hora }}
                                        </td>
                                        <td>
                                            <i class="fas fa-user me-1 text-muted"></i>
                                            {{ log.usuario }}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if log.nivel == 'user' else 'warning' if log.nivel == 'admin' else 'primary' }}">
                                                {{ log.nivel }}
                                            </span>
                                        </td>
                                        <td class="fw-semibold">{{ log.acao }}</td>
                                        <td class="text-muted">{{ log.descricao }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                            Nenhum log encontrado
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard administrativo carregado');
        
        // Adicionar animações aos cards
        document.querySelectorAll('.stat-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('fade-in-up');
        });
    });

    // Função para processar solicitações de recuperação de senha
    async function processarSolicitacaoSenha(solicitacaoId, username, acao) {
        const acaoTexto = acao === 'aprovar' ? 'aprovar' : 'rejeitar';
        const acaoTitulo = acao === 'aprovar' ? 'Aprovar' : 'Rejeitar';
        
        // Confirmação
        const result = await Swal.fire({
            title: `${acaoTitulo} Solicitação`,
            text: `Deseja ${acaoTexto} a solicitação de recuperação de senha do usuário "${username}"?`,
            icon: acao === 'aprovar' ? 'question' : 'warning',
            showCancelButton: true,
            confirmButtonColor: acao === 'aprovar' ? '#28a745' : '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: `Sim, ${acaoTexto}`,
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        try {
            // Mostrar loading
            Swal.fire({
                title: 'Processando...',
                text: `${acaoTitulo}ando solicitação de senha`,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(`/admin/processar-solicitacao-senha/${solicitacaoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    acao: acao,
                    csrf_token: document.querySelector('input[name="csrf_token"]')?.value || ''
                })
            });

            const data = await response.json();

            if (data.success) {
                await Swal.fire({
                    title: 'Sucesso!',
                    text: data.message,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Recarregar a página para atualizar a lista
                window.location.reload();
            } else {
                throw new Error(data.message || 'Erro desconhecido');
            }

        } catch (error) {
            console.error('Erro ao processar solicitação:', error);
            Swal.fire({
                title: 'Erro!',
                text: error.message || 'Erro ao processar solicitação de senha',
                icon: 'error',
                confirmButtonColor: '#dc3545'
            });
        }
    }

    // Expor função globalmente
    window.processarSolicitacaoSenha = processarSolicitacaoSenha;
</script>
{% endblock %}